name: Deploy to Timeweb Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            PROJECT_DIR="$HOME/cargo-marketplace"
            REPO_URL="https://github.com/${{ github.repository }}.git"

            # First deploy: clone
            if [ ! -d "$PROJECT_DIR/.git" ]; then
              echo ">>> First deploy: cloning..."
              mkdir -p "$PROJECT_DIR"
              git clone "$REPO_URL" "$PROJECT_DIR"
            fi

            cd "$PROJECT_DIR"

            echo ">>> Fixing permissions..."
            chown -R $(whoami):$(id -gn) "$PROJECT_DIR"

            echo ">>> Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Check if Docker is available
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              echo ">>> Docker found, using Docker deploy..."

              # Auto-detect env file
              if [ -f ".env" ]; then
                ENV_FILE=".env"
              elif [ -f ".env.production" ]; then
                ENV_FILE=".env.production"
              else
                echo "WARNING: No .env or .env.production found, creating from example..."
                if [ -f ".env.production.example" ]; then
                  cp .env.production.example .env.production
                  ENV_FILE=".env.production"
                  echo "Created .env.production from example."
                  echo "SSH into server and edit: nano $PROJECT_DIR/.env.production"
                  echo "Then re-run this workflow or run: bash deploy/deploy.sh"
                  exit 1
                fi
                exit 1
              fi

              echo ">>> Using env file: $ENV_FILE"

              # Configure nginx â€” prefer SSL if certs exist
              source "$ENV_FILE"
              APP_DOMAIN="${APP_DOMAIN:-}"

              if [ -f "deploy/nginx-ssl.conf" ] && [ -d "/etc/letsencrypt/live/${APP_DOMAIN}" ]; then
                cp deploy/nginx-ssl.conf deploy/nginx.conf
                echo ">>> Using SSL nginx config"
              elif [ -f "deploy/nginx-no-ssl.conf" ]; then
                cp deploy/nginx-no-ssl.conf deploy/nginx.conf
                echo ">>> Using non-SSL nginx config"
              fi

              if [ -f "deploy/nginx.conf" ] && [ -n "$APP_DOMAIN" ]; then
                sed -i "s/YOUR_DOMAIN.com/$APP_DOMAIN/g" deploy/nginx.conf
                sed -i "s/cargomarketplace.ru/$APP_DOMAIN/g" deploy/nginx.conf
              fi

              # Build web and bot
              echo ">>> Building containers..."
              docker compose -f docker-compose.prod.yml --env-file "$ENV_FILE" build web bot

              # Start infrastructure first
              echo ">>> Starting infrastructure..."
              docker compose -f docker-compose.prod.yml --env-file "$ENV_FILE" up -d postgres redis minio

              # Deploy application (entrypoint handles DB migrations)
              echo ">>> Deploying application..."
              docker compose -f docker-compose.prod.yml --env-file "$ENV_FILE" up -d web bot

              # Start nginx
              echo ">>> Starting nginx..."
              docker compose -f docker-compose.prod.yml --env-file "$ENV_FILE" up -d nginx certbot
              docker compose -f docker-compose.prod.yml exec -T nginx nginx -s reload 2>/dev/null || true

              # Wait for web to become healthy
              echo ">>> Waiting for web to become healthy..."
              sleep 10
              RETRIES=0
              while [ $RETRIES -lt 30 ]; do
                if docker compose -f docker-compose.prod.yml ps web | grep -q "(healthy)"; then
                  echo ">>> Web service is healthy!"
                  break
                fi
                RETRIES=$((RETRIES + 1))
                sleep 2
              done

              echo ">>> Deploy complete!"
              docker compose -f docker-compose.prod.yml ps

            else
              echo ">>> Docker not found, using PM2 deploy..."

              # Ensure Node.js/pnpm are in PATH
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
              export PATH="$HOME/.local/share/pnpm:$HOME/.nvm/versions/node/$(ls $HOME/.nvm/versions/node/ 2>/dev/null | tail -1)/bin:$PATH"

              echo ">>> Installing dependencies..."
              pnpm install --frozen-lockfile 2>/dev/null || npm install

              echo ">>> Cleaning previous build artifacts..."
              rm -rf apps/web/.next

              echo ">>> Building..."
              pnpm build 2>/dev/null || npx turbo build

              echo ">>> Restarting with PM2..."
              if command -v pm2 &> /dev/null; then
                if pm2 describe cargo-web > /dev/null 2>&1; then
                  pm2 restart cargo-web
                else
                  pm2 start ecosystem.config.js
                  pm2 save
                fi
                echo ">>> PM2 deploy complete!"
                pm2 status
              else
                echo "WARNING: PM2 not found. Install with: npm install -g pm2"
                echo "Then run: pm2 start ecosystem.config.js && pm2 save"
              fi
            fi
