/**
 * publish-knowledge â€” OpenClaw skill
 *
 * ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ SEO-ÑÑ‚Ğ°Ñ‚ÑŒÑ Ğ¸Ğ· Telegram, Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ²ÑĞµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹
 * Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ñƒ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ cargo-marketplace Ñ‡ĞµÑ€ĞµĞ· REST API.
 *
 * Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹:
 *   /publish <Ñ‚ĞµĞºÑÑ‚ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸>
 *   /Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒÑ <Ñ‚ĞµĞºÑÑ‚ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸>
 *   Ğ˜Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸ ÑÑ‚Ğ°Ñ‚ÑŒÑ â€” Ğ±Ğ¾Ñ‚ ÑĞ¿Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ.
 *
 * Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°:
 *   cp publish-knowledge.js ~/.openclaw/skills/
 *
 * Env vars (Ğ² openclaw.json Ğ¸Ğ»Ğ¸ .env):
 *   CARGO_API_URL   â€” https://your-domain.com
 *   BOT_API_KEY     â€” ÑĞµĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ (ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ñ BOT_API_KEY Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ)
 */

export const meta = {
  name: "publish-knowledge",
  description:
    "ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚ SEO-ÑÑ‚Ğ°Ñ‚ÑŒÑ Ğ² Ğ±Ğ°Ğ·Ñƒ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ cargo-marketplace. " +
    "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑŒÑ Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹ /publish Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ¾Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ».",
  triggers: ["/publish", "/Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒÑ", "/ÑÑ‚Ğ°Ñ‚ÑŒÑ"],
};

export async function run({ message, llm, http, reply, env }) {
  const apiUrl = env.CARGO_API_URL || "http://localhost:3000";
  const botKey = env.BOT_API_KEY;

  if (!botKey) {
    await reply("âŒ BOT_API_KEY Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ OpenClaw.");
    return;
  }

  // Ğ¢ĞµĞºÑÑ‚ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸ = Ğ²ÑÑ‘ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
  const articleText = message.text
    .replace(/^\/(publish|Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒÑ|ÑÑ‚Ğ°Ñ‚ÑŒÑ)\s*/i, "")
    .trim();

  if (articleText.length < 100) {
    await reply(
      "ğŸ“ ĞŸÑ€Ğ¸ÑˆĞ»Ğ¸ Ñ‚ĞµĞºÑÑ‚ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /publish\n\n" +
        "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:\n/publish\n# Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº ÑÑ‚Ğ°Ñ‚ÑŒĞ¸\n\nĞ¢ĞµĞºÑÑ‚ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸..."
    );
    return;
  }

  await reply("â³ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑ ÑÑ‚Ğ°Ñ‚ÑŒÑ, Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°Ñ SEO-Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹...");

  // â”€â”€ Ğ¨Ğ°Ğ³ 1: LLM Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ²ÑĞµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const extraction = await llm.chat([
    {
      role: "system",
      content: `Ğ¢Ñ‹ SEO-ÑĞºÑĞ¿ĞµÑ€Ñ‚. Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¸Ğ· SEO-ÑÑ‚Ğ°Ñ‚ÑŒĞ¸ Ğ¸ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ JSON Ğ±ĞµĞ· markdown-Ğ±Ğ»Ğ¾ĞºĞ¾Ğ².

ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ĞµĞ¹:
- title: Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº ÑÑ‚Ğ°Ñ‚ÑŒĞ¸ (H1 Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°), Ğ¼Ğ°ĞºÑ 120 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
- slug: URL-friendly Ğ²ĞµÑ€ÑĞ¸Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ»Ğ°Ñ‚Ğ¸Ğ½Ğ¸Ñ†Ğ° Ğ¸ Ğ´ĞµÑ„Ğ¸ÑÑ‹, Ğ¼Ğ°ĞºÑ 80 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
- description: Ğ¼ĞµÑ‚Ğ°-Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ SEO, 120-160 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ², Ñ‘Ğ¼ĞºĞ¾ Ğ¸ Ñ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğ¼Ğ¸ ÑĞ»Ğ¾Ğ²Ğ°Ğ¼Ğ¸
- content: Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸ Ğ² Markdown (ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ, Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸, ÑĞ¿Ğ¸ÑĞºĞ¸)
- category_slug: Ğ¾Ğ´Ğ½Ğ¾ Ğ¸Ğ· [gruzoperevozki, mezhdugorodnye-perevozki, dokumenty, spravochnik, faq] Ğ¸Ğ»Ğ¸ null
- tag_slugs: Ğ¼Ğ°ÑÑĞ¸Ğ² ÑĞ»Ğ°Ğ³Ğ¾Ğ² Ñ‚ĞµĞ³Ğ¾Ğ² Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: ["dostavka", "gruzy", "logistika"]), Ğ¼Ğ°ĞºÑ 5
- faq_items: Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹-Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ° FAQ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ), Ğ¼Ğ°ÑÑĞ¸Ğ² {question, answer}
- sources: Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸/ÑÑÑ‹Ğ»ĞºĞ¸ ĞµÑĞ»Ğ¸ ÑƒĞ¿Ğ¾Ğ¼ÑĞ½ÑƒÑ‚Ñ‹, Ğ¼Ğ°ÑÑĞ¸Ğ² {title, url}
- author_name: Ğ¸Ğ¼Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ° ĞµÑĞ»Ğ¸ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾ Ğ¸Ğ»Ğ¸ null
- is_featured: true Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ÑÑ‚Ğ°Ñ‚ÑŒÑ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ²Ğ°Ğ¶Ğ½Ğ°Ñ/Ñ„Ğ»Ğ°Ğ³Ğ¼Ğ°Ğ½ÑĞºĞ°Ñ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ false)

Ğ’ĞµÑ€Ğ½Ğ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ JSON, Ğ±ĞµĞ· Ğ¿Ğ¾ÑÑĞ½ĞµĞ½Ğ¸Ğ¹:
{
  "title": "...",
  "slug": "...",
  "description": "...",
  "content": "...",
  "category_slug": "...",
  "tag_slugs": [],
  "faq_items": [],
  "sources": [],
  "author_name": null,
  "is_featured": false
}`,
    },
    {
      role: "user",
      content: articleText,
    },
  ]);

  // â”€â”€ Ğ¨Ğ°Ğ³ 2: ĞŸĞ°Ñ€ÑĞ¸Ğ¼ JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let params;
  try {
    const raw = extraction.content.trim().replace(/^```json\s*|```\s*$/g, "");
    params = JSON.parse(raw);
  } catch (e) {
    await reply(
      "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°Ğ·Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ· Ğ¸Ğ»Ğ¸ ÑƒĞ¿Ñ€Ğ¾ÑÑ‚Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ‚ĞµĞºÑÑ‚Ğ°."
    );
    return;
  }

  // â”€â”€ Ğ¨Ğ°Ğ³ 3: ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const preview =
    `ğŸ“‹ *ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ ÑÑ‚Ğ°Ñ‚ÑŒĞ¸:*\n\n` +
    `**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** ${params.title}\n` +
    `**Slug:** \`${params.slug}\`\n` +
    `**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:** ${params.description}\n` +
    `**ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ:** ${params.category_slug || "Ğ±ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸"}\n` +
    `**Ğ¢ĞµĞ³Ğ¸:** ${params.tag_slugs?.join(", ") || "Ğ½ĞµÑ‚"}\n` +
    `**FAQ Ğ¿ÑƒĞ½ĞºÑ‚Ğ¾Ğ²:** ${params.faq_items?.length || 0}\n` +
    `**Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ²:** ${params.sources?.length || 0}\n\n` +
    `ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒÑ ÑĞµĞ¹Ñ‡Ğ°Ñ...`;

  await reply(preview);

  // â”€â”€ Ğ¨Ğ°Ğ³ 4: ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµĞ¼ Ñ‡ĞµÑ€ĞµĞ· API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let result;
  try {
    result = await http.post(`${apiUrl}/api/knowledge-publish`, {
      headers: {
        "Content-Type": "application/json",
        "X-Bot-Key": botKey,
      },
      body: JSON.stringify({
        ...params,
        status: "published",
      }),
    });
  } catch (e) {
    await reply(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸: ${e.message}`);
    return;
  }

  if (!result.ok) {
    const err = await result.json().catch(() => ({ error: result.statusText }));
    await reply(`âŒ API Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ: ${err.error || result.status}`);
    return;
  }

  const data = await result.json();

  // â”€â”€ Ğ¨Ğ°Ğ³ 5: Ğ£ÑĞ¿ĞµÑ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  await reply(
    `âœ… *Ğ¡Ñ‚Ğ°Ñ‚ÑŒÑ Ğ¾Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ğ½Ğ°!*\n\n` +
      `ğŸ“Œ **${params.title}**\n` +
      `ğŸ”— ${apiUrl}${data.url}\n` +
      `ğŸ†” ID: \`${data.id}\`\n\n` +
      `Ğ¡Ñ‚Ğ°Ñ‚ÑŒÑ ÑƒĞ¶Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.`
  );
}
